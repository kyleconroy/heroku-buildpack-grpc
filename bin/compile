#!/usr/bin/env bash

# fail fast
set -e

echo "-----> Installing GRPC 0.11"

BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

cd $BUILD_DIR

# download the binary (-O) silently (-s)
curl -OLs https://github.com/kyleconroy/heroku-buildpack-grpc/releases/download/release-0_11/grpc.tar.gz

# make a directory to untar (like unzip) the binary
mkdir -p usr/local/grpc

# untar the binary to the directory we want
tar -C usr/local/grpc -xf grpc.tar.gz

rm grpc.tar.gz

DIR="$BUILD_DIR/usr/local/grpc"
export PATH="$DIR/bin:$PATH"
export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"
export LIBRARY_PATH="$DIR/lib:$LIBRARY_PATH"
export INCLUDE_PATH="$DIR/include:$INCLUDE_PATH"
export CPATH="$INCLUDE_PATH"
export CPPPATH="$INCLUDE_PATH"
export PKG_CONFIG_PATH="$DIR/lib/pkgconfig:$PKG_CONFIG_PATH"

#give environment to later buildpacks
export | grep -E -e ' (PATH|LD_LIBRARY_PATH|LIBRARY_PATH|INCLUDE_PATH|CPATH|CPPPATH|PKG_CONFIG_PATH)='  > "$LP_DIR/export"
