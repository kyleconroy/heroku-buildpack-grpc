#!/usr/bin/env bash

# fail fast
set -e

echo "-----> Installing GRPC 0.11"

BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

cd $BUILD_DIR

# download the binary (-O) silently (-s)
curl -OLs https://github.com/kyleconroy/heroku-buildpack-grpc/releases/download/release-0_11/grpc-release-0_11.tar.gz

# make a directory to untar (like unzip) the binary
mkdir -p usr/local/grpc

# untar the binary to the directory we want
tar -C usr/local/grpc -xf grpc-release-0_11.tar.gz

rm grpc-release-0_11.tar.gz

echo "-----> Writing profile script"

mkdir -p $BUILD_DIR/.profile.d
cat <<EOF >$BUILD_DIR/.profile.d/grpc.sh
export PATH="\$HOME/usr/local/grpc/bin:\$PATH"
export LD_LIBRARY_PATH="\$HOME/usr/local/grpc/lib:\$LD_LIBRARY_PATH"
export LIBRARY_PATH="\$HOME/usr/local/grpc/lib:\$LIBRARY_PATH"
export INCLUDE_PATH="\$HOME/usr/local/grpc/include:\$INCLUDE_PATH"
export CPATH="\$INCLUDE_PATH"
export CPPPATH="\$INCLUDE_PATH"
export PKG_CONFIG_PATH="\$HOME/usr/local/grpc/pkgconfig:\$PKG_CONFIG_PATH"
EOF
